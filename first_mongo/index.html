<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시판 로그인</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #auth, #post-section { margin-bottom: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>🚀 로그인 & 게시판</h1>

    <!-- 회원가입 / 로그인 폼 -->
    <div id="auth">
        <h2>회원가입 / 로그인</h2>
        <input type="text" id="username" placeholder="아이디">
        <input type="password" id="password" placeholder="비밀번호">
        <button onclick="register()">회원가입</button>
        <button onclick="login()">로그인</button>
        <button onclick="logout()" class="hidden" id="logoutBtn">로그아웃</button>
    </div>

    <!-- 글 작성 폼 (로그인한 사용자만 가능) -->
    <div id="post-section" class="hidden">
        <h2>글 작성</h2>
        <input type="text" id="title" placeholder="제목">
        <textarea id="content" placeholder="내용"></textarea>
        <button onclick="createPost()">글 작성</button>
    </div>

    <!-- 게시글 목록 -->
    <div id="posts">
        <h2>게시글 목록</h2>
        <ul id="post-list"></ul>
    </div>

    <script>
        const API_URL = "http://localhost:3000"; // Express 서버 주소

        // 로그인 상태 확인
        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem("token")) {
                document.getElementById("post-section").classList.remove("hidden");
                document.getElementById("logoutBtn").classList.remove("hidden");
            }
            fetchPosts();
        });

        // 회원가입
        function register() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            fetch(`${API_URL}/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            })
            .then(res => res.json())
            .then(data => alert(data.message));
        }

        // 로그인
        function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            fetch(`${API_URL}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            })
            .then(res => res.json())
            .then(data => {
                if (data.token) {
                    localStorage.setItem("token", data.token);
                    alert("로그인 성공!");
                    location.reload(); // 새로고침
                } else {
                    alert("로그인 실패");
                }
            });
        }

        // 로그아웃
        function logout() {
            localStorage.removeItem("token");
            alert("로그아웃 되었습니다.");
            location.reload();
        }

        // 게시글 작성 (로그인한 사용자만 가능)
        function createPost() {
            const title = document.getElementById("title").value;
            const content = document.getElementById("content").value;
            const token = localStorage.getItem("token");

            if (!token) {
                alert("로그인 후 글을 작성할 수 있습니다.");
                return;
            }

            fetch(`${API_URL}/posts`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}` 
                },
                body: JSON.stringify({ title, content })
            })
            .then(res => res.json())
            .then(data => {
                alert("게시글이 작성되었습니다.");
                fetchPosts(); // 게시글 새로 불러오기
            });
        }

        // 게시글 목록 불러오기
        function fetchPosts() {
            fetch(`${API_URL}/posts`)
            .then(res => res.json())
            .then(posts => {
                const postList = document.getElementById("post-list");
                postList.innerHTML = ""; // 기존 목록 초기화
                posts.forEach(post => {
                    const li = document.createElement("li");
                    li.innerHTML = `<strong>${post.title}</strong> - ${post.author.username} <br> ${post.content}`;
                    postList.appendChild(li);
                });
            });
        }
    </script>
</body>
</html>
