<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œíŒ ë¡œê·¸ì¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #auth, #post-section { margin-bottom: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>ğŸš€ ë¡œê·¸ì¸ & ê²Œì‹œíŒ</h1>

    <!-- íšŒì›ê°€ì… / ë¡œê·¸ì¸ í¼ -->
    <div id="auth">
        <h2>íšŒì›ê°€ì… / ë¡œê·¸ì¸</h2>
        <input type="text" id="username" placeholder="ì•„ì´ë””">
        <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button onclick="register()">íšŒì›ê°€ì…</button>
        <button onclick="login()">ë¡œê·¸ì¸</button>
        <button onclick="logout()" class="hidden" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ê¸€ ì‘ì„± í¼ (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê°€ëŠ¥) -->
    <div id="post-section" class="hidden">
        <h2>ê¸€ ì‘ì„±</h2>
        <input type="text" id="title" placeholder="ì œëª©">
        <textarea id="content" placeholder="ë‚´ìš©"></textarea>
        <button onclick="createPost()">ê¸€ ì‘ì„±</button>
    </div>

    <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
    <div id="posts">
        <h2>ê²Œì‹œê¸€ ëª©ë¡</h2>
        <ul id="post-list"></ul>
    </div>

    <script>
        const API_URL = "http://localhost:3000"; // Express ì„œë²„ ì£¼ì†Œ

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem("token")) {
                document.getElementById("post-section").classList.remove("hidden");
                document.getElementById("logoutBtn").classList.remove("hidden");
            }
            fetchPosts();
        });

        // íšŒì›ê°€ì…
        function register() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            fetch(`${API_URL}/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            })
            .then(res => res.json())
            .then(data => alert(data.message));
        }

        // ë¡œê·¸ì¸
        function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            fetch(`${API_URL}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            })
            .then(res => res.json())
            .then(data => {
                if (data.token) {
                    localStorage.setItem("token", data.token);
                    alert("ë¡œê·¸ì¸ ì„±ê³µ!");
                    location.reload(); // ìƒˆë¡œê³ ì¹¨
                } else {
                    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
                }
            });
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.removeItem("token");
            alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        }

        // ê²Œì‹œê¸€ ì‘ì„± (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê°€ëŠ¥)
        function createPost() {
            const title = document.getElementById("title").value;
            const content = document.getElementById("content").value;
            const token = localStorage.getItem("token");

            if (!token) {
                alert("ë¡œê·¸ì¸ í›„ ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            fetch(`${API_URL}/posts`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}` 
                },
                body: JSON.stringify({ title, content })
            })
            .then(res => res.json())
            .then(data => {
                alert("ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                fetchPosts(); // ê²Œì‹œê¸€ ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
            });
        }

        // ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        function fetchPosts() {
            fetch(`${API_URL}/posts`)
            .then(res => res.json())
            .then(posts => {
                const postList = document.getElementById("post-list");
                postList.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
                posts.forEach(post => {
                    const li = document.createElement("li");
                    li.innerHTML = `<strong>${post.title}</strong> - ${post.author.username} <br> ${post.content}`;
                    postList.appendChild(li);
                });
            });
        }
    </script>
</body>
</html>
